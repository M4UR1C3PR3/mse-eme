<!DOCTYPE html>

<!-- Copyright (c) 2014, CableLabs, Inc.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 * this list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 * this list of conditions and the following disclaimer in the documentation
 * and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */
-->

<html lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>CableLabs MSE-EME Reference Platform - Software Documentation</title>
    <meta name="generator" content="CableLabs" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link type="text/css" href="lib/bootstrap-custom/css/bootstrap.css" rel="stylesheet">
    <link type="text/css" href="lib/highlight/styles/github.css" rel="stylesheet">
    <link type="text/css" href="css/doc.css" rel="stylesheet">
  </head>

        <!--[if lt IE 9]>
          <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

  <body style="padding-top: 100px;">
    <header class="navbar navbar-custom navbar-fixed-top" role="banner">
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <div class="navbar-header">
              <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a href="http://www.cablelabs.com" class="navbar-brand"><img src="images/CAB_logo_BW.png" alt="CableLabs"></a>
            </div>
            <p class="navbar-text navbar-right">MSE-EME Reference Platform Documentation</p>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <nav class="collapse navbar-collapse" role="navigation">
              <ul class="nav navbar-nav">
                <li class="dropdown">
                  <a href="overview.html">Overview</a>
                </li>
                <li class="dropdown active-page">
                  <a href="#" class="dropdown-toggle current" data-toggle="dropdown">Content Creation <b class="caret"></b></a>
                  <ul class="dropdown-menu">
                    <li><b>Content Creation</b></li>
                    <li class="divider"></li>
                    <li><a href="creation.html#transcoding">Transcoding/Transrating</a>
                    <li><a href="creation.html#encryption">Encryption</a>
                    <li><a href="creation.html#packaging">DASH Segmenting/Packaging</a>
                  </ul>
                </li>
                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown">Playback <b class="caret"></b></a>
                  <ul class="dropdown-menu">
                    <li><a href="playback.html">Playback</a></li>
                    <li class="divider"></li>
                    <li><a href="playback.html#clientapps">Client Player Applications</a>
                    <li><a href="playback.html#browsers">Browsers</a>
                    <li><a href="playback.html#servers">License Servers</a>
                  </ul>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="row">
        <div class="col-md-12">

          <h4><em>Confidential material under the terms of the Limited Distribution Non-disclosure Agreement between Comcast and CableLabs</em></h4>
          <hr>

          <h1 id="content-creation">Content Creation</h1>
          <p>This section describes several open source tools along with scripts we have developed to transcode/transrate, encrypt (with one or more DRMs), and perform DASH segmentation/packaging of existing MP4/H.264 content.</p>

          <p>For creating content, we have explored options both in the open-source and commercial spaces. While the tools documented below may not represent an exhaustive list of the options available in either space, they provided the shortest path to achieving desired levels of functionality for the project.  We have mostly focused on content that follows the <a href="http://dashif.org/white-papers/">DASH-AVC/264</a> guidelines as established by the <a href="http://www.dashif.org">DASH Industry Forum</a>.</p>

          <p>For our evaluation, we received a functionality-limited version of the commercially available <a href="http://www.fokus.fraunhofer.de/en/fame/projects/current_projects/famium/index.html">FAMIUM</a> toolset from Fraunhofer FOKUS.  Instructions for the Fraunhofer tools can be found in a <a href="resources/famium/FAMIUM%20DASH%20Transcoder%20Toolset.pdf">separate document</a>.  Where applicable, we will augment their provided information with our own.</p>

          <h2 id="transcoding">Media Transcoding/Transrating</h2>
          <p>The first step in creating DASH content is to transcode your high-quality source content to AVC/H.264 video and AAC audio in various resolutions and bitrates.</p>

          <h3 id="libav">libAV</h3>
          <p>For open-source offerings, we chose <a href="http://www.libav.org">libAV</a> for transcoding and transrating.  libAV is a fork of the <a href="http://www.ffmpeg.org">ffmpeg</a> project and still maintains some compatibility with ffmpeg as far as command-line structure and usage is concerned. Therefore, it may be possible to take these instructions and use them with ffmpeg instead.  All build instructions below have been tested on Ubuntu 13.10 but may work on any Debian-based Linux distribution.</p>

          <p>First install the basic components for git and software compilation.</p>
          <pre><code class="language-bash">$ sudo apt-get install essential-build git yasm</code></pre>

          <p>For transcoding video to H.264 and AAC-LC you will need to build libav from source, with those components enabled.  First you must install the development libraries for libx264 and libfdk-aac.</p>
          <pre><code class="language-bash">$ sudo apt-get install libx264-dev libfdk-aac-dev</code></pre>

          <p>Then get the libav sources from git. Configure, build, and install.</p>
          <pre><code class="language-bash">$ git clone git://git.libav.org/libav.git
$ cd libav
$ ./configure --enable-nonfree --enable-gpl --enable-libx264 --enable-libfdk-aac
$ make
$ sudo make install</code></pre>

          <p>Once you have libav built, you have a wide variety of choices for generating your adaptive bitrate streams. You must run <span class="code">avconv</span> once for each adaptive profile.  Below is an example that will generate 2 adaptive streams (AVC High @ L3.1) at 2Mb/s and 3Mb/s:</p>
          <pre><code class="language-bash">$ avconv -i input_720p.mov
          -codec:v libx264 -profile:v high -level 31 -b:v 2000k
          -codec:a libfdk_aac -profile:a aac_low
          abr_720p_h264-2Mb-high-3.1_aac-lc.mp4
$ avconv -i input720p.mov
          -codec:v libx264 -profile:v high -level 31 -b:v 3000k
          -codec:a libfdk_aac -profile:a aac_low
          abr_720p_h264-3Mb-high-3.1_aac-lc.mp4</code></pre>

          <p>Here is a more complex example that produces 5 adaptive profiles with varying bitrates, H.264 profiles and levels, and scaled resolutions (all with 1 audio bitrate transcoded to AAC-LC):</p>
          <pre><code class="language-bash">$ avconv -i input_1080p.mov -vf "scale=w=512:h=288"
          -codec:v libx264 -profile:v main -level 21 -b:v 360k
          -codec:a libfdk_aac -profile:a aac_low
          abr_512x288_h264-360Kb_aac-lc.mp4
$ avconv -i input_1080p.mov -vf "scale=w=704:h=396"
          -codec:v libx264 -profile:v main -level 30 -b:v 620k
          -codec:a libfdk_aac -profile:a aac_low
          abr_704x396_h264-620Kb_aac-lc.mp4
$ avconv -i input_1080p -vf "scale=w=896:h=504"
          -codec:v libx264 -profile:v high -level 31 -b:v 1340k
          -codec:a libfdk_aac -profile:a aac_low
          abr_896x504_h264-1340Kb_aac-lc.mp4
$ avconv -i input_1080p.mov -vf "scale=w=1280:h=720"
          -codec:v libx264 -profile:v high -level 32 -b:v 2500k
          -codec:a libfdk_aac -profile:a aac_low
          abr_1280x720_h264-2500Kb_aac-lc.mp4
$ avconv -i input_1080p.mov -vf "scale=w=1920:h=1080"
          -codec:v libx264 -profile:v high -level 40 -b:v 4500k
          -codec:a libfdk_aac -profile:a aac_low
          abr_1920x1080_h264-4500Kb_aac-lc.mp4</code></pre>

          <h3 id="famium_transcoder">FAMIUM Transcoder</h3>

          <p>The FAMIUM Transcoder is a Java application which will transcode/transrate an input file into a set of predefined ABR profiles.  Documentation provided to us by the FAMIUM team can be found <a href="resources/famium/FAMIUM%20DASH%20Transcoder%20Toolset.pdf">here</a>.

          <div class="alert alert-warning">The version of FAMIUM transcoder provided to CableLabs is feature limited and does not represent the full capabilities of the commercial tool you can license from Fraunhofer.  However, the FAMIUM team has provided us with a <a href="resources/famium/2014-03-14_FamiumRoad.pdf">roadmap</a> of current and planned features for their tools.</div>

          <p>The Java application extracts a Windows version of FFMpeg for performing the actual transcode.  Therefore, you must run the FAMIUM transcode tool on a Windows platform</p>

          <div class="alert alert-warning">Our restricted version of the FAMIUM transcoder does not support anything other than 2-channel audio.  So, if you are trying to test the tool with your own content, you might have to down-mix your audio to stereo first.</div>

          <p>The ouput of the FAMIUM tool is placed in a directory called 'plain'.  In that directory you will find separate directories for audio and video streams (the FAMIUM transcoder demuxes your input stream to separate the video and audio).  Within the audio and video directories are subdirectories containing the individual bitrate profiles for each stream.</p>

          <div class="alert alert-warning">Do not modify the output directory structure or filenames produced by the FAMIUM transcoder tool.  The FAMIUM DASH segmenter/packager relies on this exact configuration to do its work.</div>

          <h2 id="encryption">Encryption</h2>
          <p>All of the examples in this documentation will use the ISO Common Encryption standard for ISO BMFF files (ISO 23009-7). The Common Encryption specification defines a single set of encryption parameters for all content to make the decryption process more simple and consistent across players.  The following restrictions are enforced:</p>
          <ul>
            <li>AES 128-bit block encryption</li>
            <li>CBC (Cipher Block Chaining) or CTR (Counter) Block Modes</li>
            <li>64-bit or 128-bit Initialization Vectors</li>
            <li>128-bit Key IDs</li>
          </ul>
          <p>In addition to the required encryption standards, the specification defines several new boxes that describe how encrypted content is to be represented in ISO BMFF containers.  These new boxes indicate which tracks within the media have encrypted samples and which samples within that track are actually encrypted.  Each set of encrypted samples is assoicated with a encryption key ID.  It is possible to have alternating sequences of encrypted and unencrypted samples.  It is also possible to have multiple encryption key IDs associated with various samples throughout the media.  However, each contiguous set of encrypted samples may only be encrypted by a single key ID.</p>
          <p>The box that contains DRM-specific information is called the 'pssh' (Protection System Specific Header).  This box contains all the information the CDM and/or player application will need to retrieve decryption keys from the DRM-specific license server.  The following sections desribe how to use our tools to encrypt the content and build and insert one or more DRM-specific 'pssh' boxes.</p>

          <p>To encrypt our ABR content, we use the open-source <a href="http://gpac.wp.mines-telecom.fr/mp4box/">MP4Box</a> tool from the <a href="http://gpac.wp.mines-telecom.fr/">GPAC</a> project (maintained by <a href="http://www.telecom-paristech.fr/">Telecom ParisTech</a>).  Please note that it is possible to do some forms of non-CommonEncryption using the MP4Box tool, but it will not be covered in this documentation.  We have added features and fixed many bugs in MP4Box over the course of our development, so we recommend that you download one of the <a href="http://gpac.wp.mines-telecom.fr/downloads/gpac-nightly-builds/">nightly builds</a> or build it from <a href="http://sourceforge.net/svn/?group_id=84101">source</a>.</p>

          <p>The basic usage of MP4Box for content encryption is:</p>

          <pre><code>MP4Box -crypt &lt;cryptfile&gt; -out &lt;outputfile&gt; &lt;inputfile&gt;</code></pre>

          <p>A helper script is provided with our tools to execute the MP4box encryption process on multiple files.  This is very helpful when encrypting multiple ABR content files.</p>

          <div class="panel panel-success">
            <div class="panel-heading">encrypt/encrypt.sh</div>
            <div class="panel-body">
              <pre><code class="scrollable-code">$ ./encrypt.sh
Encryption Script
usage:
   encrypt.sh -o &lt;output_directory&gt; -c &lt;cryptfile&gt; [-i &lt;input_directory&gt;] [INPUT_FILE]...

OPTIONS
  -o
       The output directory where encrypted files will be written

  -c
       The cryptfile.  XML MP4Box input file used to define the encryption.

  -i
       All files in the given directory will be encrypted.  Can be used instead of or in addition
       to the list of files at the end of the command
              </code></pre>
            </div>
          </div>

          <h3>CryptfileBuilder</h3>

          <p>CableLabs has developed a set of tools to assist in the generation of <em>cryptfiles</em>.  A cryptfile is the primary input to MP4Box that describes exactly how the content should be encrypted.  A cryptfile also specifies the contents of any 'pssh' boxes to be inserted into the encrypted content.  One of the CableLabs tools, CryptfileBuilder, is a Java library on top of which you can develop your own DRM-specific cryptfile generator applications.  It defines the basic building blocks for MP4Box cryptfiles including bitstream (<span class="code">&lt;BS&gt;</span>), crypt track (<span class="code">&lt;CryptTrack&gt;</span>), and key (<span class="code">&lt;key&gt;</span>) elements</p>

          <p>Using MP4Box to do Common Encryption is pretty well documented <a href="http://gpac.wp.mines-telecom.fr/mp4box/encryption/common-encryption/">here</a>.  In the following sections we details several DRM-specific tools CableLabs has developed using the CryptfileBuilder library.</p>

          <h3 id="playready">Microsoft PlayReady</h3>

          <p>Microsoft provides <a href="http://www.microsoft.com/playready/documents/">several documents</a> that describe the PlayReady DRM system.  These documents detail the DRM metadata that is inserted in content files along with special instructions for doing PlayReady content protection in MPEG-DASH. The first step in creating PlayReady encrypted content is to generate your encryption keys.</p>

          <h4 id="playready_keygen">Encryption Key Generation</h4>

          <p>Microsoft has made a <a href="http://playready.directtaps.net/pr/doc/customrights/">test license server</a> available for developers who wish to test their implementations.  This server can accept query string arguments that apply different attributes to the returned license based on the desired content rights.  Since we can not store our own encryption keys in the test license server, we need a way to ensure that the keys we use to encrypt our content will be the same keys that are returned by the license server upon playback.  Microsoft has defined an algorithm (detailed at the end of <a href="http://download.microsoft.com/download/2/0/2/202E5BD8-36C6-4DB8-9178-12472F8B119E/PlayReady%20Header%20Object%204-15-2013.docx">this document</a> in the section titled <b>Content Key Algorithm</b>) that developers can use to generate their own keys based on a unique <i>key seed</i> assigned to the server and a user-defined <i>key ID</i>.  The CableLabs cryptfile generator for PlayReady will generate encryption keys according to this algorithm along with a few other crucial pieces of data required for the encyption process.  Here is an example of a generated encryption key and checksum based a specified key ID.  The binary-encoded forms of the key ID (discussed more later) are also shown.</p>

          <div class="well">
            <pre><code>===============================================
Content key ID =
  0x10000000100010001000100000000001
  0x00000010001000101000100000000001 (MS binary)
  EAAAABAAEAAQABAAAAAAAQ== (Base64)
  AAAAEAAQABAQABAAAAAAAQ== (Base64, MS binary)
Content key =
  0x3A2A1B68DD2BD9B2EEB25E84C4776668
  OiobaN0r2bLusl6ExHdmaA== (Base64)
Checksum =
  0xE53CC8610DA1ACE6
  5TzIYQ2hrOY= (Base64)
===============================================</code></pre>
          </div>

          <h4>PlayReady Header Object</h4>

          <p>The data contents of the 'pssh' box as described by the <a href="http://download.microsoft.com/download/2/0/2/202E5BD8-36C6-4DB8-9178-12472F8B119E/PlayReady%20Header%20Object%204-15-2013.docx">Microsoft documentation</a> is the PlayReady Header Object (PRO).  The PRO is a list of PlayReady <em>records</em>.  Records can be of various types, but the only one we will be concerned with is the <b>rights management header</b> (type 0x0001).  The rights managment header is a UTF-16 little-endian encoded XML document designated by the top-level Windows Rights Management Header element (WRMHEADER).  Here is an example rights management header generated internally by our PlayReady cryptfile builder:</p>

          <div class="panel panel-success">
            <div class="panel-body">
              <pre><code>&lt;WRMHEADER xmlns="http://schemas.microsoft.com/DRM/2007/03/PlayReadyHeader" version="4.0.0.0"&gt;
  &lt;DATA&gt;
    &lt;PROTECTINFO&gt;
      &lt;KEYLEN&gt;16&lt;/KEYLEN&gt;
      &lt;ALGID&gt;AESCTR&lt;/ALGID&gt;
    &lt;/PROTECTINFO&gt;
    &lt;KID&gt;AAAAEAAQABAQABAAAAAAAQ==&lt;/KID&gt;
    &lt;CHECKSUM&gt;5TzIYQ2hrOY=&lt;/CHECKSUM&gt;
    &lt;LA_URL&gt;http://playready.directtaps.net/pr/svc/rightsmanager.asmx?PlayRight=1&amp;amp;UseSimpleNonPersistentLicense=1&lt;/LA_URL&gt;
  &lt;/DATA&gt;
&lt;/WRMHEADER&gt;</code></pre>
            </div>
          </div>

          <p>The rights management header in this example conforms to version 4.0.0.0.  The Microsoft documentation also describes a version 4.1.0.0 rights management header that contains the same data, but it a little more compact.  We haven't been able to get content to play properly when using the 4.1.0.0 header as of the writing of this document.</p>

          <p>You can see two values in the rights management header that we pulled from the key generation process.  The first value (Checksum, Base64) goes into the <span class="code">CHECKSUM</span> element.  The other value (Content Key ID, Base64, MS binary) goes into the <span class="code">KID</span> element.  This is the base64 and binary-encoded key ID that we associated with our encryption key.  <a href="http://en.wikipedia.org/wiki/Guid#Binary_encoding">Microsoft's method for binary-encoding GUIDs</a> is little bit different than what you expect. The first 8 bytes are divided into 3 fields of 4 bytes, 2 bytes, and 2 bytes.  Each field is encoded using native byte ordering (little-endian on x86 systems).  The last 8 bytes are always encoded big-endian, regardless of the native OS. Look closely at the output of the PlayReadyKeygen tool to see the difference between the original key ID and the binary-encoded key ID.</p>

          <div class="well">
            <pre class="text-center">A1B1C1D1-A2B2-A3B3-A4B4-A5B5C5D5E5F5<br>D1C1B1A1-B2A2-B3A3-A4B4-A5B5C5D5E5F5</pre>
          </div>

          <h4>PlayReady Cryptfile Generator</h4>

          <p>Our PlayReady Cryptfile Generator tool performs all of the previous steps to create a cryptfile that will allow MP4Box to encrypt multiple tracks (potentianlly with multiple keys per track).  Here is an example of what a complete PlayReady cryptfile would look like:</p>

          <div class="panel panel-success">
            <div class="panel-body">
              <pre><code>&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
&lt;GPACDRM type="CENC AES-CTR"&gt;
  &lt;DRMInfo type="pssh" version="0"&gt;
    &lt;BS ID128="9a04f07998404286ab92e65be0885f95"/&gt;
    &lt;BS bits="32" endian="little" value="762"/&gt;
    &lt;BS bits="16" endian="little" value="1"/&gt;
    &lt;BS bits="16" endian="little" value="1"/&gt;
    &lt;BS bits="16" endian="little" value="752"/&gt;
    &lt;BS data64="PABXAFIATQBIAEUAQQBEAEUAUgAgAHgAbQBsAG4AcwA9ACIAaAB0AHQAcAA6AC8ALwBzAGMAaABlAG0AYQBzAC4AbQBpAGMAcgBvAHMAbwBmAHQALgBjAG8AbQAvAEQAUgBNAC8AMgAwADAANwAvADAAMwAvAFAAbABhAHkAUgBlAGEAZAB5AEgAZQBhAGQAZQByACIAIAB2AGUAcgBzAGkAbwBuAD0AIgA0AC4AMAAuADAALgAwACIAPgA8AEQAQQBUAEEAPgA8AFAAUgBPAFQARQBDAFQASQBOAEYATwA+ADwASwBFAFkATABFAE4APgAxADYAPAAvAEsARQBZAEwARQBOAD4APABBAEwARwBJAEQAPgBBAEUAUwBDAFQAUgA8AC8AQQBMAEcASQBEAD4APAAvAFAAUgBPAFQARQBDAFQASQBOAEYATwA+ADwASwBJAEQAPgBBAEEAQQBBAEUAQQBBAFEAQQBCAEEAUQBBAEIAQQBBAEEAQQBBAEEAQQBRAD0APQA8AC8ASwBJAEQAPgA8AEMASABFAEMASwBTAFUATQA+ADUAVAB6AEkAWQBRADIAaAByAE8AWQA9ADwALwBDAEgARQBDAEsAUwBVAE0APgA8AEwAQQBfAFUAUgBMAD4AaAB0AHQAcAA6AC8ALwBwAGwAYQB5AHIAZQBhAGQAeQAuAGQAaQByAGUAYwB0AHQAYQBwAHMALgBuAGUAdAAvAHAAcgAvAHMAdgBjAC8AcgBpAGcAaAB0AHMAbQBhAG4AYQBnAGUAcgAuAGEAcwBtAHgAPwBQAGwAYQB5AFIAaQBnAGgAdAA9ADEAJgBhAG0AcAA7AFUAcwBlAFMAaQBtAHAAbABlAE4AbwBuAFAAZQByAHMAaQBzAHQAZQBuAHQATABpAGMAZQBuAHMAZQA9ADEAPAAvAEwAQQBfAFUAUgBMAD4APAAvAEQAQQBUAEEAPgA8AC8AVwBSAE0ASABFAEEARABFAFIAPgA="/&gt;
  &lt;/DRMInfo&gt;
  &lt;CrypTrack IV_size="8" first_IV="0x81171442af182143" isEncrypted="1" saiSavedBox="senc" trackID="1"&gt;
    &lt;key KID="0x10000000100010001000100000000001" value="0x3a2a1b68dd2bd9b2eeb25e84c4776668"/&gt;
  &lt;/CrypTrack&gt;
&lt;/GPACDRM&gt;</code></pre>
            </div>
          </div>

          <p>Let's look at the bottom portion of the file first.  You can add a <span class="code">CrypTrack</span> element for each track in the content that you want to encrypt (identified by its track ID from the Track Header ('tkhd') box).  Within that element, you can specific one or more encryption keys and associated key ID.  If you provide more than one key, use the <span class="code">roll</span> attribute of the <span class="code">CrypTrack</span> element to indicate how many samples should be encrypted with each key.</p>

          <p>The <span class="code">DRMInfo</span> element defines the 'pssh' box that will be inserted into the encrypted content.  As per the Common Encryption spec, the DRM type is identified by the 16-byte GUID "System ID" field followed by the DRM-specific data.  The <span class="code">CrypTrack</span> element identifies a track within the source media to be encrypted and associates one or more encryption key/keyID pairs to perform the encryption.</p>

          <div class="panel panel-success">
            <div class="panel-heading">mp4/playready/encrypt.sh</div>
            <div class="panel-body">
              <pre><code class="scrollable-code"> #!/bin/bash

# Confidential material under the terms of the Limited Distribution Non-disclosure
# Agreement between CableLabs and Comcast

function usage {
  echo ""
  echo "PlayReady Encryption Script"
  echo "usage:"
  echo "   encrypt.sh -o &lt;output_directory&gt; -v [4000|4100] [-i &lt;input_directory&gt;] [INPUT_FILE]..."
  echo ""
  echo "OPTIONS"
  echo "  -o"
  echo "       The output directory where encrypted files will be written"
  echo ""
  echo "  -v"
  echo "       The PlayReady Header Object version.  Must be either 4000 (4.0.0.0) or 4100 (4.1.0.0)"
  echo ""
  echo "  -i"
  echo "       All files in the given directory will be encrypted.  Can be used instead of or in addition"
  echo "       to the list of files at the end of the command"
}

while getopts ":o:v:i:" opt; do
  case $opt in
    o)
      output_dir=$OPTARG
      ;;
    v)
      pr_wrm_version=$OPTARG
      ;;
    i)
      input_dir=$OPTARG
      ;;
    \?)
      echo "Invalid option: -$OPTARG" &gt;&amp;2
      usage
      exit 1
      ;;
    :)
      echo "Missing options argument for -$OPTARG" &gt;&amp;2
      usage
      exit 1
      ;;
  esac
done
shift $((OPTIND - 1))

if [ -z $pr_wrm_version ]; then
  echo "Must provide PlayReady version argument (either 4000 or 4100)"
  usage
  exit 1
fi
if [ -z $output_dir ]; then
  echo "Must provide output directory for encrypted media files"
  usage
  exit 1
fi
if [ -z $input_dir -a ${#@} -eq 0 ]; then
  echo "No input media files specified!"
  usage
  exit 0
fi

pr_utf16file="wrm_utf16.xml"
pr_cryptfile="cryptfile"

# Remove all leading whitespace and then remove all end of line characters
# Then convert to UTF-16LE
sed 's/^[ \t]*//' playready_wrm_v${pr_wrm_version}.xml | tr -d '\r\n' | iconv -f UTF-8 -t UTF-16LE &gt; $pr_utf16file

# Grab file size and insert into our crypt file template
pr_wrm_size=`du -b $pr_utf16file | awk '{print $1}'`
pr_total_size=`expr $size + 10`
sed -e "s/___WRM_SIZE___/$pr_wrm_size/" \
  -e "s/___PRHO_SIZE___/$pr_total_size/" \
  -e "s/___WRM_FILE___/$pr_utf16file/" playready_cenc.xml &gt; $pr_cryptfile

mkdir -p $output_dir

# Encrypt all files in optional input directory
if [ ! -z $input_dir ]; then
  for file in `ls $input_dir`; do
    MP4Box -crypt $pr_cryptfile $input_dir/$file -out $output_dir/`basename $file`
  done
fi

# Encrypt individual files specified at the end of the command
for file in $@; do
  MP4Box -crypt $pr_cryptfile $file -out $output_dir/`basename $file`
done

rm $pr_cryptfile
rm $pr_utf16file</code></pre>
            </div>
          </div>

          <p>Lets walk through the functionality of this script to highlight the last little nuances of encrypting PlayReady content.</p>
          <ol>
            <li>Remove all whitespace from the rights management header file that is not part of the XML structure and convert to UTF16 little-endian format. <em><b>This step is essential.</b></em>  If you leave even a single newline character in the file, the CDM will not successfully parse it.</li>
            <li>Calculate the size of the newly "re-formatted" rights management header because it must be inserted into the cryptfile along with the filename itself. (A good enhancement to the MP4Box tool would be to insert the size automatically when adding the contents of a file.)</li>
            <li>Calculate the total size of the PRO by adding 10 bytes; 4 bytes for the Record Type (2) and Record Length (2) fields for this record and 6 bytes for the Length (4) and PlayReady Record Count (2) fields of the PRO.</li>
            <li>Execute sed scripts to replace the underscore fields in the template cryptfile to produce the actual file.</li>
            <li>Execute MP4Box for each ABR profile to create the encrypted content files.</li>
          </ol>

          <h3 id="primetime">Adobe PrimeTime</h3>

          Coming Soon

          <h3 id="widevine">Google Widevine</h3>

          Coming Soon

          <h3 id="clearkey">ClearKey</h3>

          <p>The EME spec mandates browser support for a Simple Decryption system called <a href="https://dvcs.w3.org/hg/html-media/raw-file/default/encrypted-media/encrypted-media.html#simple-decryption-clear-key">Clear Key</a>.  The specification only provides the format of the decryption key data passed to the <span class="code">MediaKeySession.update()</span> EME API.  We wanted to develop a simple implementation that would show evidence of support (or lack of support) for Clear Key in browsers.  Additionally, our implementation creates a starting point for discussions regarding Clear Key integration with the Common Encryption standard.</p>

          <h4>Common Encryption</h4>

          <p>The primary task in getting Clear Key to work with Common encryption is to define the contents of the 'pssh' box in ISO BMFF files.  As shown in previous sections, each DRM vendor has developed their own data format for the 'pssh' that communicates the DRM-specific data that they believe to relevant and important.  In implementing our Clear Key solution, we wanted to cover two basic use-cases:</p>
          <ol>
            <li>Decryption key(s) is contained within the media itself.  In this case, keys may be transported over the network in the clear (assuming the media is carried over a network).</li>
            <li>Decryption key(s) is retrieved from a remote server (similar to real DRMs).  Keys may be transported securely over the network (e.g. via HTTPS) and are only in the clear within the javascript code running on the browser.</li>
          </ol>

          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title"><em>Clear Key PSSH Box Data</em></h4>
            </div>
            <div class="panel-body">
              <pre><code>    clearkey_pssh_data {
        unsigned int (8)                  <b>type</b>
        if (type == 0) {
            unsigned int(16)              <b>url_length</b>
            unsigned int(8)[url_length]   <b>url (base64-encoded)</b>
        }
        else if (type == 1) {
            unsigned int(16)              <b>jwk_length</b>
            unsigned int(8)[jwk_length]   <b>jwk (base64-encoded)</b>
        }
    }</code></pre>

              <ul>
                <li><b><code>type</code></b> : A value of 0 indicates that the decryption keys will be retrieved from a remote server vi HTTP GET request to the provided URL.  A value of 1 indicates that the decryption keys are stored within the 'pssh' data.</li>
                <li><b><code>url_length</code></b> : The length in bytes of the <code>url</code> field</li>
                <li><b><code>url</code></b> : Base64-encoded, UTF-8 URL string that will be used to retrieve the keys required for this content.  The javascript application will simply issue an HTTP GET request to this URL to retrieve the decryption keys.  The HTTP response will be a JSON object that conforms to the JSON Web Key (JWK) definition referenced in the EME Clear Key specification.</li>
                <li><b><code>jwk_length</code></b> : The length in bytes of the <code>jwk</code> field</li>
                <li><b><code>jwk</code></b> : Base64-encoded, UTF-8 string representation of the JSON Web Key (JWK) object.  This object will be passed to the <span class="code">update()</span> EME API after Base64 decode and conversion to <span class="code">Uint8Array</span>.</li>
              </ul>
            </div>
          </div>

          <p>We have arbitrarily and independently selected the GUID of <code>00000000-0000-0000-0000-000000000001</code> to use as the System ID for our Clear Key implementation.  This GUID is not regsistered with any central number registrar.  Below is an example MP4Box cryptfile showing an how to use our type 0 Clear Key implementation in content encryption.</p>
          <div class="panel panel-success">
            <div class="panel-heading">mp4/clearkey/clearkey_cenc.xml</div>
            <div class="panel-body">
              <pre><code>&lt;GPACDRM type="CENC AES-CTR"&gt;
  &lt;DRMInfo type="pssh" version="0"&gt;
    &lt;BS ID128="00000000000000000000000000000000" /&gt;  &lt;!-- ClearKey SystemID --&gt;
    &lt;BS bits="8" value="0" /&gt;                        &lt;!-- ClearKey Type (0 = URL, 1 = JSON) --&gt;

    &lt;!-- URL length and URL --&gt;
    &lt;BS bits="16" string="http://localhost:8584/?keyid=10000000100010001000100000000001&amp;keyid=10000000100010001000100000000002" /&gt;
  &lt;/DRMInfo&gt;

  &lt;CrypTrack trackID="1" IsEncrypted="1" IV_size="8" first_IV="0x7DF7C12E832F9726" saiSavedBox="senc" &gt;
    &lt;key KID="0x10000000100010001000100000000002" value="0x07E4D653CFB45C66158D93FFCE422907" /&gt;
  &lt;/CrypTrack&gt;
&lt;/GPACDRM&gt;</code></pre>
            </div>
          </div>

          <h4>dash.js Player</h4>

          <p>We have added support to the dash.js player for parsing the Clear Key 'pssh' from the <span class="code">initData</span> attribute of the <span class="code">needkey</span> EME event.  The player looks for a 'pssh' with the <code>00000000-0000-0000-0000-000000000000</code> guid we have assigned to our implementation of Clear Key, parses the data and then adds the key(s) (possibly retrieved from a remote server) to the browser using the EME <span class="code">update()</span> API.  See the <span class="code">clearkeyGetUpdate()</span> function in <span class="code">app/js/streaming/ProtectionExtensions.js</span>.</p>

          <h3 id="multi_drm">Common Encryption Multi-DRM</h3>

          <p>One of the fundamental benfits of Common Encryption is the ability to encrypt content once while still supporting multiple proprietary DRM systems.  Up until this point, we have only demonstrated the encryption of content using a single DRM.  This section takes what we have learned in the previous sections and describes how to use MP4Box to encrypt a piece of content with multiple key systems that can be played back on the disparate platforms that support those systems.</p>

          <p>With MP4Box, it is quite simple to apply multiple DRMs to a piece of content;  you just add multiple <span class="code">&lt;DRMInfo&gt;</span> elements to the cryptfile.  Each one will introduce a new 'pssh' box into the content.</p>

          <div class="panel panel-success">
            <div class="panel-heading">mp4/multiple_enc/cenc_pr_ck.xml</div>
            <div class="panel-body">
              <pre><code>&lt;GPACDRM type="CENC AES-CTR"&gt;
  &lt;DRMInfo type="pssh" version="0"&gt;
    &lt;BS ID128="00000000000000000000000000000000" /&gt;  &lt;!-- ClearKey SystemID --&gt;
    &lt;BS bits="8" value="0" /&gt;                        &lt;!-- ClearKey Type (0 = URL, 1 = JSON) --&gt;

    &lt;!-- URL length and URL --&gt;
    &lt;BS bits="16" string="http://localhost:8584/?keyid=10000000100010001000100000000001&amp;keyid=10000000100010001000100000000002" /&gt;
  &lt;/DRMInfo&gt;

  &lt;DRMInfo type="pssh" version="0"&gt;
    &lt;BS ID128="9a04f07998404286ab92e65be0885f95" /&gt;  &lt;!-- PlayReady SystemID --&gt;
    &lt;!--MP4Box automaically inserts the 32-bit PSSH size field here --&gt;

    &lt;BS bits="32" value="___PRHO_SIZE___" endian="little" /&gt;     &lt;!-- PlayReady Header Object Size --&gt;
    &lt;BS bits="16" value="1" endian="little" /&gt;       &lt;!-- Number of records --&gt;

    &lt;!-- First record --&gt;
    &lt;BS bits="16" value="1" endian="little" /&gt;       &lt;!-- Rights Management record type --&gt;
    &lt;BS bits="16" value="___WRM_SIZE___" endian="little" /&gt;     &lt;!-- Record length --&gt;
    &lt;BS dataFile="___WRM_FILE___" dataLength="0" /&gt;           &lt;!-- WRM in external file --&gt;
  &lt;/DRMInfo&gt;

  &lt;CrypTrack trackID="1" IsEncrypted="1" IV_size="8" first_IV="0x7DF7C12E832F9726" saiSavedBox="senc" &gt;
    &lt;key KID="0x10000000100010001000100000000001" value="0x3A2A1B68DD2BD9B2EEB25E84C4776668" /&gt;
  &lt;/CrypTrack&gt;
&lt;/GPACDRM&gt;</code></pre>
            </div>
          </div>

          <p>There is an interesting caveat when using our tools to do multi-DRM Common Encryption;  KeyID and decryption key must be the same across all DRMs.  Content samples are only encrypted with a single key/keyID.  Multiple keys can be used to encrypt a single piece of content (rolling keys), but only a single key per individual media sample.  With the PlayReady test server, we can't install our own keys manually.  We must rely on the key generation algorithm.  Luckily, our Clear Key test server is completely under our control and we can simply install the same key generated by the PlayReady algorithm.  In commercial deployments, DRM license servers must support the manual installation of keys so that a single content encryption process can select the keyID and key and then install it across all DRM servers.</p>

          <h2 id="packaging">DASH Segmenting and Packaging</h2>

          <p>The final step in the content creation process is to segment/index our media files and then create a DASH manifest file (.mpd).  Our test tools create content that attempts to adhere to the DASH-AVC/264 guidelines.  Therefore, we are restricted to a subset of the functionality that appears in the MPEG-DASH specification.  MP4Box, once again, is our tool of choice for performing DASH segmenting and packaging.  MP4Box supports a large assortment of command-line options when DASHing content.  You can run <span class="code">MP4Box -h dash</span> to see a complete description of all options.  The basic usage of the tool looks likes this:</p>

          <pre><code>MP4Box -dash &lt;seg_duration&gt; -profile &lt;profile&gt; -out &lt;mpdfile&gt; &lt;inputfiles&gt;</code></pre>

          <ul>
            <li><span class="code">&lt;seg_duration&gt;</span> is the requested duration of each media segment after segmentation</li>
            <li><span class="code">&lt;profile&gt;</span> is the desired MPEG-DASH profile (onDemand, live, main, simple, etc...)</li>
            <li><span class="code">&lt;mpdfile&gt;</span> is the location and filename of the DASH Media Presentation Description file that will be written</li>
            <li><span class="code">&lt;inputfiles&gt;</span> specifies the input media files that will be parsed  and segmented to produce new output media files.  There will be one Representation in the MPD file for each input file specified.</li>
          </ul>

          <h3>isobmff-ondemand Profile</h3>

          <p>For On-Demand (VOD) content, MP4Box will produce a single fragmented MP4 file for each audio/video/text component of your input video across each ABR profile.  If your input contains multiplexed A/V data, the output files from MP4Box will be de-multiplexed audio and video in separate files; one for each ABR bitrate.  In fact, DASH-AVC/264 guidelines require demultiplexed content and separate Adaptation Sets for each A/V component.  Here is an example command line from one of our scripts that creates DASH On-Demand content:</p>

          <pre><code>MP4Box -dash 10000 -rap -bs-switching no -sample-groups-traf \
  -profile onDemand -out bbb_720p_h264_enc.mpd \
  $content_root_dir/bbb_720p_h264-2Mb-high-3.1_aac-lc_enc.mp4#video:id=2Mb \
  $content_root_dir/bbb_720p_h264-2Mb-high-3.1_aac-lc_enc.mp4#audio:id=audio \
  $content_root_dir/bbb_720p_h264-3Mb-high-3.1_aac-lc_enc.mp4#video:id=3Mb</code></pre>

          <p>With this command we are generating MPEG-DASH content with 10 second segment duration from 2 video bitrates and 1 audio bitrate.  Audio and video Representations will be separated into their own AdaptationSet. The important takeaways from that command are:</p>

          <ul>
            <li><span class="code">-rap</span> This indicates that each segment must begin with a random access point (I-frame).  Using this option, segment durations may not be exactly what you requested due to the fact that RAPs might not land exactly on those time boundaries.</li>
            <li><span class="code">-bs-switching no</span> At the time, Google Chrome could not handle anything other than <b>avc1</b> and <b>avc2</b> type ISOBMFF tracks (SPS/PPS stored in the sample entry).  Without this option, MP4Box would generate <b>avc3</b> type tracks (SPS/PPS stored inband in the samples themselves).  This may have changed with later versions of chrome.</li>
            <li><span class="code">-sample-groups-traf</span> The standard MP4Box behavior when generating fragmented MP4s is to place Sample Group Description ('sgpd') boxes in the Movie ('moov') box and the corresponding Sample To Group ('sbgp') boxes in the Movie Fragment ('moof') boxes.  This behavior is not allowed by the <a href="http://www.uvvuwiki.com/images/c/cb/CFFMediaFormat-1.1r1.pdf">DECE Common File Format</a> specification.  Microsoft's Internet Explorer 11 will <em>only</em> parse media files that conform to the CFF.</li>
            <li><span class="code">#video:id=2Mb</span> These suffix arguments to our input files tell MP4Box to do several things.  First, it allows us to tell MP4Box to demultiplex our mulitplexed input files and to use the first video (<span class="code">#video</span>) or audio (<span class="code">#video</span>) track from the file for a particular Representation.  It also allows us to specify attribute values on the Representation elements (id, bandwith, xlink, role) in the generated MPD.  Multiple attributes can be specified, separated by commas.</li>
          </ul>

          <div class="alert alert-danger">
            <b>NOTE:</b> DASH-AVC/264 requires the ContentProtection element in the MPD to be in the AdaptationSet.  MP4Box currently places the ContentProtection element in each Representation.  <b><em>You must manually edit your MPD to move the ContentProtection element(s) from any of the contained Representations in to the parent AdaptationSet.</em></b>
          </div>

          <p>Here is an example MPD generated from command line shown above.  The content was encrypted using our Common Encryption tools with Microsoft PlayReady.  As you can see, there is no indication that PlayReady DRM is being used or if more than one DRM available to decrypt the content.  All of that is hidden by Common Encryption and will be discovered by the client player application at playback-time.</p>

          <pre><code>&lt;?xml version="1.0"?&gt;
&lt;!-- MPD file Generated with GPAC version 0.5.1-DEV-rev5178M  on 2014-03-28T17:35:25Z--&gt;
&lt;MPD xmlns="urn:mpeg:dash:schema:mpd:2011" minBufferTime="PT1.500000S" type="static" mediaPresentationDuration="PT0H0M33.05S" profiles="urn:mpeg:dash:profile:isoff-on-demand:2011" xmlns:cenc="urn:mpeg:cenc:2013"&gt;
 &lt;ProgramInformation moreInformationURL="http://gpac.sourceforge.net"&gt;
  &lt;Title&gt;bbb_720p_h264_enc.mpd generated by GPAC&lt;/Title&gt;
 &lt;/ProgramInformation&gt;

 &lt;Period id="" duration="PT0H0M33.05S"&gt;
  &lt;AdaptationSet segmentAlignment="true" maxWidth="1280" maxHeight="720" maxFrameRate="25" par="16:9" subsegmentStartsWithSAP="1"&gt;
   &lt;ContentProtection schemeIdUri="urn:mpeg:dash:mp4protection:2011" value="cenc" cenc:default_KID="a1b1c1d1-a2b2-a3b3-a4b4-a5b5c5d5e5f5"/&gt;
   &lt;Representation id="2Mb" mimeType="video/mp4" codecs="avc1.64001f" width="1280" height="720" frameRate="25" sar="1:1" startWithSAP="1" bandwidth="1971252"&gt;
    &lt;BaseURL&gt;bbb_720p_h264-2Mb-high-3.1_aac-lc_enc_track1_dashinit.mp4&lt;/BaseURL&gt;
    &lt;SegmentBase indexRangeExact="true" indexRange="1783-1862"/&gt;
   &lt;/Representation&gt;
   &lt;Representation id="3Mb" mimeType="video/mp4" codecs="avc1.64001f" width="1280" height="720" frameRate="25" sar="1:1" startWithSAP="1" bandwidth="2912401"&gt;
    &lt;BaseURL&gt;bbb_720p_h264-3Mb-high-3.1_aac-lc_enc_track1_dashinit.mp4&lt;/BaseURL&gt;
    &lt;SegmentBase indexRangeExact="true" indexRange="1783-1862"/&gt;
   &lt;/Representation&gt;
  &lt;/AdaptationSet&gt;
  &lt;AdaptationSet segmentAlignment="true" subsegmentStartsWithSAP="1"&gt;
   &lt;Representation id="audio" mimeType="audio/mp4" codecs="mp4a.40.2" audioSamplingRate="48000" startWithSAP="1" bandwidth="490735"&gt;
    &lt;AudioChannelConfiguration schemeIdUri="urn:mpeg:dash:23003:3:audio_channel_configuration:2011" value="2"/&gt;
    &lt;BaseURL&gt;bbb_720p_h264-2Mb-high-3.1_aac-lc_enc_track2_dashinit.mp4&lt;/BaseURL&gt;
    &lt;SegmentBase indexRangeExact="true" indexRange="1635-1714"/&gt;
   &lt;/Representation&gt;
  &lt;/AdaptationSet&gt;
 &lt;/Period&gt;
&lt;/MPD&gt;</code></pre>

          <p>Even though there is only one file generated for each Representation, the files are still segmented.  The player application can quickly access the segment index ('sidx') box to determine where the various segments begin and end within the file.  The <span class="code">&lt;SegmentBase&gt;</span> element tells the application exactly where the 'sidx' box is within the overall file.</p>

          <h3>isobmff-live Profile</h3>
          Coming Soon

       </div>
      </div>
    </div>

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="lib/bootstrap-custom/js/bootstrap.js"></script>
    <script type="text/javascript" src="lib/highlight/highlight.pack.js"></script>
    <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
    <script type='text/javascript'>
      $(document).ready(function() {
      });
    </script>
  </body>
</html>
